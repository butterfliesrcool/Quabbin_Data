---
title: "assumptions"
author: "Abby Robinson"
date: "10/25/2022"
output: html_document
---

Packages 
```{r}
library(curl)
library(lme4)
library(car)
require(MASS)
library(ggplot2)
library(mlmRev)
library(agridat)
library(MCMCglmm)
library(pscl)
```

```{r}
d <- curl("https://raw.githubusercontent.com/butterfliesrcool/Quabbin_Data/main/Quabbin_Count_Data.csv")
data <- read.csv(d, header = TRUE, sep = ",")
head(data)
```

```{r}
hist(data$attacks) ## Based on histrogram of bird attacks, data appears to be zero-inflated 
```
```{r}
library(fitdistrplus)
plotdist(data$attacks, histo = TRUE, demp = TRUE)
```

```{r}
  var(data$attacks)
  mean(data$attacks)
##variance is greater than mean, which indicated that data are overdispersed. 
##run check_overdispersion(x, ...) on the model to check for overdispersion 
```

NOTES: 
The negative binomial distribution is similar to the Poisson except it has an additional parameter called a scale parameter. The scale parameter (𝜹) allows the variance to be larger (or smaller) than the mean and may reduce or remedy the over-dispersion problem. Some argue that the negative binomial should always be used for agricultural data while others disagree. 

###In statistics, a zero-inflated model is a statistical model based on a zero-inflated probability distribution, i.e. a distribution that allows for frequent zero-valued observations.

Zero-inflated negative binomial regression is for modeling count variables with excessive zeros and it is usually for over-dispersed count outcome variables. Furthermore, theory suggests that the excess zeros are generated by a separate process from the count values and that the excess zeros can be modeled independently.

```{r}
nbinom <- fitdist(data$attacks, "nbinom")
plot(nbinom)

poisson <- fitdist(data$attacks, "pois")
plot(poisson)

exp <- fitdist(data$attacks, "exp")
plot(exp)
```

```{r}
nbinom.f<- fitdist(data$attacks, "nbinom") # Negative Binomial 
pois.f<- fitdist(data$attacks, "pois") # Poisson
norm.f<- fitdist(data$attacks, "norm") # Normal 
exp.f<- fitdist(data$attacks, "exp") # Exponential 
```

```{r}
summary(nbinom.f)
summary(pois.f)
summary(norm.f)
summary(exp.f)
```

```{r}
par(mfrow = c(2, 2))
plot.legend <- c("Binomial neg", "Poisson")
denscomp(list(nbinom.f,pois.f), legendtext = plot.legend)
qqcomp(list(nbinom.f,pois.f), legendtext = plot.legend)

cdfcomp(list(nbinom.f,pois.f), legendtext = plot.legend)
ppcomp(list(nbinom.f,pois.f), legendtext = plot.legend)
```
```{r}
library(remotes)
library(NBZIMM) ##Negative Binomial Zero Inflated Generalized Linear Mixed Model 
library(nlme)
```

```{r}
f = glmm.zinb(fixed = attacks ~ species + trial + day + time.delay , 
              random = ~ 1 | site, data = data, zi_fixed = ~1) 
summary(f)
summary(f$zi.fit)
```
```{r}
model <- subset(data, trial == "model", drop = FALSE)
hist(model$attacks)
```

```{r}
library(glmmTMB) # compared with glmmTMB
library(performance)

m1 <- glmer(attacks ~ species*day + (1|site), data =  model, family = poisson)
summary(m1)
emmeans(m1, pairwise ~ species*day) 

f0 = glmmTMB(attacks ~ species*day + (1 | site), data = model, 
            family = nbinom2, zi = ~ 1)
summary(f0)
check_overdispersion(f0) #no overdispersion detected 
```



### try glmer.nb() function: https://search.r-project.org/CRAN/refmans/lme4/html/glmer.nb.html
#### From Documentation: subset: an optional expression indicating the subset of the rows of data that should be used in the fit. This can be a logical vector, or a numeric vector indicating which observation numbers are to be included, or a character vector of the row names to be included. All observations are included by default.

##Data needs to be broken down by day for the learning check analysis but it doesn't for everything else 

##writing out data for each individual day can artificially cause increased zero inflation 

## Not accounting for overdispersion can lead to artificially small p values 
